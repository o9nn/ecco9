name: Deep Tree Echo - Git Lock Purge & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-echo-kernel:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # NEVER CANCEL - builds take time!
    
    steps:
      - name: ğŸ”“ Purge Orphaned Git Locks
        run: |
          echo "Deep Tree Echo awakens... clearing temporal locks..."
          # Remove any orphaned git locks
          find . -name "*.lock" -path "*/.git/*" -delete 2>/dev/null || true
          echo "Git locks purged. The path is clear!"
      
      - name: ğŸ“¦ Checkout Echo Kernel
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0
          
      - name: ğŸ§¹ Ensure Clean Git State
        run: |
          # Secondary cleanup if needed
          if [ -f .git/index.lock ]; then
            echo "Removing stubborn .git/index.lock"
            rm -f .git/index.lock
          fi
          git status
          
      - name: ğŸ”§ Setup Crystal Environment
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest
          
      - name: ğŸ—ï¸ Build Aphrodite Engine
        timeout-minutes: 60
        run: |
          echo "Initiating Aphrodite Engine build sequence..."
          # Your build commands here
          make build-aphrodite || echo "Build needs configuration"